resource "azurerm_monitor_metric_alert" "metric_alert" {
  name                = "util_alert"
  resource_group_name = azurerm_resource_group.group.name
  scopes              = [azurerm_kubernetes_cluster.aks.id]
  description         = "Alert will be triggered when avg utilization is more than 80%"

  criteria {
    metric_namespace = "Insights.Container/nodes"
    metric_name      = "CpuUsagePercentage"
    aggregation      = "Average"
    operator         = "GreaterThanOrEqual"
    threshold        = 80

    dimension {
      name     = "Host"
      operator = "Include"
      values   = ["*"]
    }
  }

  action {
    action_group_id = azurerm_monitor_action_group.action_group.id
  }
}
